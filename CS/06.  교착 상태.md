## 교착 상태의 개요

#### 교착상태의 정의
- 2개이상의 작업이 동시에 이루어지는 경우, 다른 작업이 끝나기만 기다리며 작업을 더 이상 진행하지 못하는 상태를 **교착 상태**라고 한다
- 교착상태는 다른 프로세스와 공유할 수 없는 자원을 사용할 때 발생
- 잠금을 사용하는 코드에서 두개의 프로세스가 모두 임계구역에 들어가지 못하는 상황도 교착상태가 발생할 수 있다
- 여러 프로세스가 데이터 베이스에 저장된 데이터를 사용할 때 일관성을 유지하지 못하는 경우에 잠금을 사용하는데, 이때 교착 상태가 발생 할 수 있다

#### 자원 할당 그래프
- 자원 할당 그래프는 프로세스가 어떤 자원을 사용중이고 어떤 자원을 기다리고 있는지 방향성이 있는 그래프로 표현 한것
- 프로세스는 원, 자원은 사각형으로 표현
- 프로세스가 자원을 사용하는경우 자원에서 프로세스로 향하는 화살표로 표시, 프로세스가 자원을 기다리는경우 프로세스에서 자원으로 향하는 화살표로 표시
- 다중자원인 경우 사각형안에 수용할 수 있는 프로세스 갯수만큼 작은동그라미로 표시
![자원할당그래프](/Data/6-1.Graph.png)

## 교착 상태 필요조건
- 상호 배제, 비선점, 점유와 대기, 원형대기의 4가지 조건을 동시에 만족해야만 교착 상태가 발생한다
- 상호 배제: 다른 프로세스와 공유 할 수 없는 배타적인 자원을 사용하면 교착 상태가 발생할 수 있다
- 비선점 : A프로세스에서 다른 B프로세스의 자원을 빼앗아 선점할 수 있으면 B프로세스는 정지되고 A프로세스는 정상적으로 작동하기 때문에 교착상태가 발생 할 수 없다
- 점유와 대기 : 다른 프로세스의 작업 진행을 방해하려면 한 프로세스에서 다른 프로세스가 필요로 하는 자원을 점유하면서 또 다른 자원을 기다리는 상태여야 한다
- 원형 대기 : 점유와 대기를 하는 프로세스들이 서로 방해하는 방향이 원을 이루어 각 프로세스들끼리 서로 양보하지 않는 상태가 되어야 한다


![데드락](/Data/6-2.Deadlock.png)

## 교착 상태 해결 방법

#### 교착 상태 해결
- 교착 상태 예방 : 상호 배제, 비선점, 점유와 대기, 원형 대기라는 4가지 조건 중 한가지라도 만족하지 못하면 교착 상태가 발생하지 않기 때문에 이 4가지 조건이 발생하지 않도록 무력화 하는 방식이다
- 교착 상태 회피 : 교착 상태를 유발할 가능성이 있다고 판단되면 자원 할당량을 조절하여 교착 상태를 해결하는 방식이다
- 교착 상태 검출과 회복 : 위의 방법과 달리 제약을 가하지 않고 자원 할당 그래프를 모니터링하면서 교착 상태가 발생하는지 살펴본 후 발생하면 회복시킨는 방식이다

#### 교착 상태 예방

##### 1) 상호 배제 예방
- 설명 : 시스템 내 배타적인 자원, 독점적으로 사용할 수 있는 자원을 없애는 방법(모든 자원을 공유할 수 있는 자원으로 만든는 방법)
- 문제점 : 모든 자원을 공유하게 되면 데이터가 엉켜 결과가 달라질 수 있다

##### 2) 비선점 예방
- 설명 : 모든 자원을 빼앗을 수 있는 상태로 만드는 방법
- 문제점 : 어떤 기준으로 빼앗을지, 빼앗은 시간중 얼마나 사용할지 결정하기가 어렵고 우선순위가 높은 프로세스가 계속 사용한다면 우선순위가 낮은 프로세스에서 아사현상이 발생할 수 있다

##### 3) 점유와 대기 예방
- 설명 : 프로세스가 자원을 점유한 상태로 다른 자원을 기다리지 못하게 하는 방법(전부 할당하거나 아예 할당하지 않는 방법)
- 문제점1 : 프로세스가 자신이 사용하는 모든 자원을 자세히 알기 어렵다
- 문제점2 : 프로세스가 모든 필요한 자원을 선점하여, 그자원이 필요한 다른프로세스의 작업이 진행되지 않아 자원의 낭비가 발생한다
- 문제점3 : 많은 자원을 사용하는 프로세스는 적은 자원을 사용하는 프로세스에 비해 자원을 동시에 확보하기 어렵기 때문에 아사현상이 발생할 수 있다

##### 4) 원형 대기 예방
- 설명 : 모든 자원에 숫자를 부여하고 숫자가 큰 방향으로만 자원을 할당하는 방법
- 문제점1 : 프로세스가 숫자가 큰 자원을 사용한 후 숫자가 작은 자원을 필요로 하는 경우, 운영체제가 이를 거부하여 프로세스를 정상적으로 진행시킬 수 없는 경우가 생긴다
- 문제점2 : 자원에 번호를 붙여 큰 자원에서 작은 자원의 방향으로 사용이 불가능해지기 때문에 숫자를 부여하는 기준이 모호해진다

#### 교착 상태 회피

##### 교착 상태 회피 설명
- 교착 상태 회피에서는 자원의 총수와 할당된 자원의 수를 기준으로 시스템을 안정상태와 불안정상태로 나누어 시스템이 안정 상태를 유지하도록 자원을 할당한다
- 불안정 상태가 되면 교착상태가 발생하는것이 아니라 발생할 확률이 높아지는 것
![그래프2](/Data/6-3.Graph2.png)

##### 교착 상태 회피 문제점
- 모든 프로세스가 자신이 사용할 자원을 미리 선언하기 어렵다
- 미리 선언한 자원이 정확지 않으면(프로세스 실행중 필요한 자원의 개수가 달라지면) 이후에 교착 상태가 발행할 수 있다
- 실제로 교착 상태가 발생하지 않는데도 발생할 것이라고 예상하고 프로세스에 자원을 할당하는데 제약을 둔다

#### 교착 상태 검출

##### 타임아웃을 이용한 교착 상태 검출
- 설명 : 일정 시간 동안 작업이 진행되지 않는 프로세스를 교착 상태가 발생한 것으로 간주하여 처리하는 방법
- 장점 : 특별한 알고리즘 없이 쉽게 구현할 수 있다
- 예시 : 윈도우 운영체제에서 '프로그램이 응답이 없어 종료합니다'라는 메시지가 대표적인 타임아웃을 이용한 교착 상태 검출의 예시이다
- 문제점1 : 교착 상태 외의 다른 이유로 작업이 진행되지 못하는 프로세스가 강제 종료 될 수 있다
- 문제점2 : 네트워크로 연결되어 있는 시스템에서 원격지에 있는 프로세스의 응답이 없는경우 교착 상태 때문인지, 네트워크 문제인지, 단순히 처리가 늦어지는 것인지 정확히 알 수 없다
- 문제점3 : 타임아웃으로 프로세스가 종료되면 일부 데이터에 문제가 발생할 수 있다(해결법으로 체크포인트와 롤백의 사용이 있다)

##### 자원 할당 그래프를 이용한 교착 상태 검출
- 설명 : 다중 자원을 사용하는 경우가 아닌 경우 하기 자원 할당 그래프와 같이 사이클(R1→P1→R2→P2→R3→P4→R1)이 발생한 경우 교착 상태로 판단한다

![그래프3](/Data/6-4.Graph3.png)
- 장점 : 작업 방식을 제한하지 않으면서 교착 상태를 정확하게 파악할 수 있다
- 문제점 : 자원할당 그래프를 유지하고, 갱신하고 사이클을 검사하는 추가 작업으로 인해 오버헤드가 발생한다

#### 교착 상태 회복
- 설명 : 교착 상태가 검출되면 하기 두가지 방법으로 교착 상태를 푸는 후속 작업을 하는데 이를 교착 상태 회복이라고 한다
- 방법1 : 교착 상태를 일으킨 모든 프로세스를 동시에 종료한다(이 방법의 경우 종료된 모든 프로세스를 다시 실행시키면 다시 교착 상태를 일으킬 확률이 높기 때문에 순차적으로 실행해야한다)
- 방법2 : 교착 상태를 일으킨 프로세스 중 하나를 골라 순서대로 종료해가며 나머지 프로세스의 상태를 파악하는 방법으로 종료 순서는 하기와 같은 기준이 필요하다
- 방법2의 순차적 프로세스 종료 순서 기준
  1) 우선순위가 낮은 프로세스를 먼저 종료
  2) 우선순위가 같으면 작업 시간이 짧은 프로세스를 먼저 종료한다
  3) 위의 두 조건이 같으면 자원을 많이 사용하는 프로세스를 먼저 종료한다
